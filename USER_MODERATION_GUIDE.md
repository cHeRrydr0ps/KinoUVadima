# Система модерации регистраций пользователей

## Обзор реализации

Реализована B2B система модерации регистраций, где новые пользователи должны получить одобрение администратора перед получением доступа к системе.

## Ключевые компоненты

### Backend (auth_service)

1. **config.py** - конфигурация email адресов:
   - ADMIN_EMAIL = "deagle-desert@mail.ru"
   - SUPPORT_EMAIL = "annnt9na@yandex.ru" 
   - FROM_EMAIL = "annnt9na@yandex.ru"

2. **email_utils.py** - утилиты отправки email:
   - `send_admin_notification()` - уведомление админу о новой регистрации
   - `send_approval_email()` - уведомление пользователю об одобрении
   - `send_rejection_email()` - уведомление пользователю об отклонении

3. **auth.py** - изменённые endpoints:
   - `/register` - создаёт пользователей с is_verified=False, отправляет уведомление админу
   - `/login` - проверяет is_verified, блокирует вход неподтверждённым пользователям

4. **admin.py** - новые admin endpoints:
   - `GET /auth/admin/users` - список всех пользователей
   - `GET /auth/admin/users/pending` - пользователи на модерации
   - `POST /auth/admin/users/{id}/approve` - одобрить пользователя
   - `POST /auth/admin/users/{id}/reject` - отклонить пользователя

### Frontend (React)

1. **adminApi.ts** - API методы для модерации:
   - `getPendingUsers()` - получить пользователей на модерации
   - `approveUser()` - одобрить пользователя
   - `rejectUser()` - отклонить пользователя с причиной

2. **UserModeration.tsx** - React компонент:
   - Отображение списка пользователей на модерации
   - Кнопки одобрения/отклонения
   - Диалог для указания причины отклонения
   - Автообновление каждые 30 секунд

3. **AdminPanel.tsx** - интеграция в админ панель:
   - Новая вкладка "Модерация"
   - Полная интеграция с существующим UI

## Процесс модерации

### 1. Регистрация нового пользователя
```
POST /auth/register
{
  "inn": "1234567890",
  "name": "Иван Иванов", 
  "email": "user@example.com",
  "password": "password123"
}
```

**Результат:**
- Пользователь создаётся с is_verified=False
- Админу отправляется email уведомление
- Пользователь получает ответ: "Регистрация принята. Ожидайте подтверждения в течение 72 часов."

### 2. Попытка входа неподтверждённого пользователя
```
POST /auth/login
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Результат:**
- HTTP 403 Forbidden
- Сообщение: "Ваша учетная запись на модерации. Ожидайте подтверждения в течение 72 часов."

### 3. Модерация администратором

**В админ панели во вкладке "Модерация":**
- Видны все пользователи с is_verified=False
- Кнопка "Одобрить" - устанавливает is_verified=True, отправляет approval email
- Кнопка "Отклонить" - удаляет пользователя, отправляет rejection email с причиной

### 4. После одобрения
- Пользователь получает email об одобрении
- Может войти в систему с обычными логином/паролем
- Получает полный доступ к функциям системы

## Email уведомления

### Уведомление админу о новой регистрации
```
Тема: Новая регистрация - user@example.com
Тело: 
Новый пользователь зарегистрировался в системе:
- Имя: Иван Иванов
- Email: user@example.com  
- ИНН: 1234567890
- Дата: 2024-01-15 14:30:00

Для модерации перейдите в админ панель.
```

### Уведомление об одобрении
```
Тема: Регистрация одобрена
Тело:
Здравствуйте, Иван Иванов!
Ваша регистрация в системе одобрена.
Теперь вы можете войти используя ваши данные.
```

### Уведомление об отклонении
```
Тема: Регистрация отклонена
Тело: 
Здравствуйте, Иван Иванов!
К сожалению, ваша регистрация отклонена.
Причина: Некорректные данные
```

## Тестирование системы

### Ручное тестирование
1. Зарегистрировать нового пользователя через форму регистрации
2. Проверить, что вход заблокирован до модерации
3. Войти как админ в админ панель
4. Открыть вкладку "Модерация"
5. Найти нового пользователя в списке
6. Одобрить или отклонить регистрацию
7. Проверить, что email уведомления отправлены
8. Проверить, что одобренный пользователь может войти

### API тестирование
```bash
# 1. Регистрация
curl -X POST http://localhost:8002/auth/register \
  -H "Content-Type: application/json" \
  -d '{"inn":"1234567890","name":"Test User","email":"test@example.com","password":"password123"}'

# 2. Попытка входа (должна быть заблокирована)
curl -X POST http://localhost:8002/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# 3. Получить список пользователей на модерации (нужен admin токен)
curl -X GET http://localhost:8002/auth/admin/users/pending \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 4. Одобрить пользователя
curl -X POST http://localhost:8002/auth/admin/users/1/approve \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 5. Попытка входа после одобрения (должна быть успешной)
curl -X POST http://localhost:8002/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```

## Особенности реализации

1. **Безопасность**: Все admin endpoints защищены проверкой роли "admin"
2. **Устойчивость**: Ошибки email не ломают основную логику регистрации/модерации
3. **UX**: Понятные сообщения пользователям о статусе регистрации
4. **Производительность**: Автообновление списка модерации каждые 30 секунд
5. **Audit**: Возможность указать причину отклонения регистрации

## Настройка email сервиса

Убедитесь, что email_service работает и настроен:
- Порт: 8003
- SMTP настройки корректны
- Email адреса в config.py соответствуют реальным

## Возможные улучшения

1. Логирование всех действий модерации
2. Уведомления в реальном времени (WebSocket)
3. Шаблоны email с брендингом
4. Статистика модерации
5. Возможность массового одобрения/отклонения